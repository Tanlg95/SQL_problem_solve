-- Create table If Not Exists Posts (post_id int, user_id int,  post_date date);
-- Truncate table Posts;
-- insert into Posts (post_id, user_id, post_date) values ('1', '1', '2024-02-27');
-- insert into Posts (post_id, user_id, post_date) values ('2', '5', '2024-02-06');
-- insert into Posts (post_id, user_id, post_date) values ('3', '3', '2024-02-25');
-- insert into Posts (post_id, user_id, post_date) values ('4', '3', '2024-02-14');
-- insert into Posts (post_id, user_id, post_date) values ('5', '3', '2024-02-06');
-- insert into Posts (post_id, user_id, post_date) values ('6', '2', '2024-02-25');


-- test case 2--- begin

Posts =
| post_id | user_id | post_date  |
| ------- | ------- | ---------- |
| 1       | 2       | 2024-02-18 |
| 2       | 5       | 2024-02-23 |
| 3       | 4       | 2024-02-19 |
| 4       | 2       | 2024-02-03 |
| 5       | 4       | 2024-02-12 |
| 6       | 3       | 2024-02-03 |
| 7       | 3       | 2024-02-05 |
| 8       | 1       | 2024-02-24 |
| 9       | 3       | 2024-02-10 |
| 10      | 2       | 2024-02-25 |
| 11      | 4       | 2024-02-12 |
| 12      | 2       | 2024-02-01 |
| 13      | 2       | 2024-02-16 |
| 14      | 5       | 2024-02-15 |
| 15      | 4       | 2024-02-06 |
| 16      | 1       | 2024-02-22 |
| 17      | 5       | 2024-02-11 |
| 18      | 4       | 2024-02-08 |
| 19      | 3       | 2024-02-04 |
| 20      | 2       | 2024-02-01 |
| 21      | 3       | 2024-02-12 |
| 22      | 3       | 2024-02-28 |
| 23      | 2       | 2024-02-23 |
| 24      | 4       | 2024-02-10 |
| 25      | 2       | 2024-02-17 |
| 26      | 2       | 2024-02-17 |
| 27      | 3       | 2024-02-06 |
| 28      | 5       | 2024-02-15 |
| 29      | 4       | 2024-02-20 |
| 30      | 5       | 2024-02-27 |
| 31      | 2       | 2024-02-15 |
| 32      | 4       | 2024-02-26 |

--output:

| user_id | max_7day_posts | avg_weekly_posts |
| ------- | -------------- | ---------------- |
| 1       | 2              | 0.5              |
| 2       | 5              | 2.5              |
| 3       | 4              | 1.75             |
| 4       | 5              | 2                |
| 5       | 3              | 1.25             |

-- test case 2 ---- end

-- test case 3 ---- begin
Posts =
| post_id | user_id | post_date  |
| ------- | ------- | ---------- |
| 1       | 3       | 2024-02-22 |
| 2       | 5       | 2024-02-22 |
| 3       | 3       | 2024-02-05 |
| 4       | 4       | 2024-02-01 |
| 5       | 3       | 2024-02-16 |
| 6       | 3       | 2024-02-21 |
| 7       | 4       | 2024-02-23 |
| 8       | 5       | 2024-02-08 |
| 9       | 5       | 2024-02-01 |
| 10      | 5       | 2024-02-05 |
| 11      | 4       | 2024-02-12 |
| 12      | 2       | 2024-02-11 |
| 13      | 2       | 2024-02-02 |
| 14      | 5       | 2024-02-27 |
| 15      | 2       | 2024-02-03 |
| 16      | 5       | 2024-02-22 |
| 17      | 3       | 2024-02-22 |
| 18      | 4       | 2024-02-26 |
| 19      | 1       | 2024-02-01 |
| 20      | 1       | 2024-02-27 |
| 21      | 5       | 2024-02-08 |
| 22      | 1       | 2024-02-14 |
| 23      | 4       | 2024-02-04 |
| 24      | 4       | 2024-02-05 |
| 25      | 5       | 2024-02-11 |
| 26      | 5       | 2024-02-18 |
| 27      | 2       | 2024-02-23 |
| 28      | 1       | 2024-02-18 |
| 29      | 2       | 2024-02-17 |
| 30      | 1       | 2024-02-13 |
| 31      | 5       | 2024-02-14 |
| 32      | 5       | 2024-02-16 |
| 33      | 4       | 2024-02-20 |
| 34      | 4       | 2024-02-18 |
| 35      | 1       | 2024-02-21 |
| 36      | 1       | 2024-02-07 |
| 37      | 3       | 2024-02-12 |
| 38      | 3       | 2024-02-28 |
| 39      | 4       | 2024-02-22 |
| 40      | 3       | 2024-02-04 |
| 41      | 3       | 2024-02-08 |
| 42      | 3       | 2024-02-12 |
| 43      | 3       | 2024-02-17 |
| 44      | 5       | 2024-02-26 |
| 45      | 5       | 2024-02-06 |
| 46      | 1       | 2024-02-13 |
| 47      | 4       | 2024-02-02 |
| 48      | 5       | 2024-02-01 |
| 49      | 2       | 2024-02-22 |
| 50      | 4       | 2024-02-02 |
| 51      | 4       | 2024-02-07 |
| 52      | 5       | 2024-02-04 |
| 53      | 5       | 2024-02-08 |
| 54      | 2       | 2024-02-03 |
| 55      | 3       | 2024-02-02 |
| 56      | 4       | 2024-02-09 |
| 57      | 4       | 2024-02-12 |
| 58      | 5       | 2024-02-21 |
| 59      | 1       | 2024-02-17 |
| 60      | 4       | 2024-02-12 |
| 61      | 2       | 2024-02-11 |
| 62      | 3       | 2024-02-15 |
| 63      | 4       | 2024-02-23 |
| 64      | 4       | 2024-02-08 |
| 65      | 2       | 2024-02-15 |
| 66      | 5       | 2024-02-12 |
| 67      | 2       | 2024-02-07 |
| 68      | 2       | 2024-02-20 |
| 69      | 1       | 2024-02-09 |
| 70      | 3       | 2024-02-06 |
| 71      | 2       | 2024-02-26 |
| 72      | 1       | 2024-02-17 |
| 73      | 1       | 2024-02-08 |
| 74      | 5       | 2024-02-04 |
| 75      | 3       | 2024-02-18 |
| 76      | 5       | 2024-02-05 |
| 77      | 1       | 2024-02-11 |
| 78      | 3       | 2024-02-21 |
| 79      | 1       | 2024-02-08 |
| 80      | 5       | 2024-02-17 |
| 81      | 4       | 2024-02-16 |
| 82      | 3       | 2024-02-09 |
| 83      | 4       | 2024-02-29 |
| 84      | 2       | 2024-02-15 |
| 85      | 3       | 2024-02-20 |
| 86      | 1       | 2024-02-09 |
| 87      | 3       | 2024-02-28 |
| 88      | 5       | 2024-02-21 |
| 89      | 4       | 2024-02-23 |
| 90      | 2       | 2024-02-24 |
| 91      | 3       | 2024-02-17 |
| 92      | 3       | 2024-02-01 |
| 93      | 1       | 2024-02-23 |
| 94      | 1       | 2024-02-05 |
| 95      | 5       | 2024-02-29 |
| 96      | 3       | 2024-02-14 |
| 97      | 2       | 2024-02-08 |
| 98      | 2       | 2024-02-14 |
| 99      | 4       | 2024-02-02 |
| 100     | 5       | 2024-02-19 |
| 101     | 5       | 2024-02-24 |
| 102     | 3       | 2024-02-25 |
| 103     | 1       | 2024-02-14 |
| 104     | 4       | 2024-02-19 |
| 105     | 1       | 2024-02-29 |
| 106     | 4       | 2024-02-26 |
| 107     | 2       | 2024-02-19 |
| 108     | 5       | 2024-02-12 |
| 109     | 3       | 2024-02-21 |
| 110     | 4       | 2024-02-19 |
| 111     | 2       | 2024-02-01 |
| 112     | 2       | 2024-02-29 |
| 113     | 1       | 2024-02-26 |
| 114     | 1       | 2024-02-29 |
| 115     | 1       | 2024-02-14 |
| 116     | 5       | 2024-02-07 |
| 117     | 4       | 2024-02-26 |
| 118     | 1       | 2024-02-23 |
| 119     | 3       | 2024-02-07 |
| 120     | 3       | 2024-02-09 |
| 121     | 5       | 2024-02-16 |
| 122     | 5       | 2024-02-20 |

--output:
| user_id | max_7day_posts | avg_weekly_posts |
| ------- | -------------- | ---------------- |

-- test case 3 ---- end


-- solution:


WITH posts_tmp AS(
	SELECT *,
	COUNT(1) OVER(PARTITION BY user_id)/ 4.0 avg_total_post,
		COUNT(1) OVER(PARTITION BY user_id , post_date) total_post_each_day
	FROM posts WHERE post_date BETWEEN '2024-02-01' AND '2024-02-28' ORDER BY user_id, post_date
)
,find_post_with_only_one_post AS(
	SELECT 
		user_id,
		COUNT(1) max_7day_posts,
		0.25 avg_weekly_posts
	FROM
		posts_tmp
	GROUP BY user_id
	HAVING COUNT(1) = 1
)
, user_more_than_one_post AS(
	SELECT 
			* 
	FROM
			posts_tmp F
	WHERE	
		NOT EXISTS (SELECT 1 FROM find_post_with_only_one_post S WHERE S.user_id = F.user_id)
)
, final AS(
	SELECT 
		user_id, 
		total_conse_post_7_day max_7day_posts,
		ROUND(avg_total_post,2) avg_weekly_posts
	FROM
		(
			SELECT 
				U.user_id,
				U.post_date,
				MAX(U.avg_total_post) avg_total_post ,
				COUNT(DISTINCT U1.post_id) total_conse_post_7_day 
			FROM 
				user_more_than_one_post U
			INNER JOIN
				user_more_than_one_post U1 ON U.user_id = U1.user_id AND U1.post_date BETWEEN U.post_date  AND U.post_date + 6
			GROUP BY U.user_id , U.post_date
			ORDER BY user_id
		)sub
	WHERE
		total_conse_post_7_day >= (avg_total_post * 2.0)
	UNION 
	SELECT user_id, MAX(max_7day_posts) max_7day_posts, MAX(avg_weekly_posts) FROM  find_post_with_only_one_post
	GROUP BY user_id
	ORDER BY user_id
)
SELECT
	user_id,
	MAX(max_7day_posts) max_7day_posts,
	MAX(avg_weekly_posts) avg_weekly_posts
FROM
	final
GROUP BY user_id